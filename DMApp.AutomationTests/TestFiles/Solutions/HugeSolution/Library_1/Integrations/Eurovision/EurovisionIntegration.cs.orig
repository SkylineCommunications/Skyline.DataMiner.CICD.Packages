namespace Skyline.DataMiner.DeveloperCommunityLibrary.YLE.Integrations.Eurovision
{
	using System;
	using System.Collections.Generic;
	using System.Globalization;
	using System.Linq;
	using System.Text.RegularExpressions;
	using Configuration;
	using Helpers;
	using Skyline.DataMiner.DeveloperCommunityLibrary.YLE.Configuration;
	using Skyline.DataMiner.DeveloperCommunityLibrary.YLE.Contracts;
	using Skyline.DataMiner.DeveloperCommunityLibrary.YLE.Event;
	using Skyline.DataMiner.DeveloperCommunityLibrary.YLE.Exceptions;
	using Skyline.DataMiner.DeveloperCommunityLibrary.YLE.Function;
	using Skyline.DataMiner.DeveloperCommunityLibrary.YLE.Integrations;
	using Skyline.DataMiner.DeveloperCommunityLibrary.YLE.Integrations.Eurovision;
	using Skyline.DataMiner.DeveloperCommunityLibrary.YLE.Notes;
	using Skyline.DataMiner.DeveloperCommunityLibrary.YLE.Order;
	using Skyline.DataMiner.DeveloperCommunityLibrary.YLE.Profile;
	using Skyline.DataMiner.DeveloperCommunityLibrary.YLE.Service;
	using Skyline.DataMiner.DeveloperCommunityLibrary.YLE.ServiceDefinition;
	using Skyline.DataMiner.DeveloperCommunityLibrary.YLE.Utilities;
	using Skyline.DataMiner.Library.Automation;
	using Skyline.DataMiner.Core.DataMinerSystem.Common;
	using Skyline.DataMiner.Library.Solutions.SRM;
	using Skyline.DataMiner.Net.Messages.SLDataGateway;
	using Skyline.DataMiner.Net.ResourceManager.Objects;

	using IntegrationUpdateStatus = Skyline.DataMiner.DeveloperCommunityLibrary.YLE.Integrations.UpdateStatus;
	using OrderStatus = Skyline.DataMiner.DeveloperCommunityLibrary.YLE.Order.Status;
	using Service = Skyline.DataMiner.DeveloperCommunityLibrary.YLE.Service.Service;
	using ServiceConfiguration = Skyline.DataMiner.DeveloperCommunityLibrary.YLE.Service.Configuration.ServiceConfiguration;
	using TaskStatus = Skyline.DataMiner.DeveloperCommunityLibrary.YLE.Tasks.Status;

	public class EurovisionIntegration : Integration
	{
		private const string EurovisionProtocolName = "EBU Synopsis Web Service";
		private const string EurovisionProtocolVersion = "Production";

		private const int SynopsesTablePid = 2000;
		private const int WorkOrdersTablePid = 7200;
		private const int WorkOrdersTableWorkOrderIdIdx = 0;
		private const int WorkOrdersTableWorkOrderTypeIdx = 2;
		private const int WorkOrdersTableNumberPid = 7202;
		private const int WorkOrdersTableTransmissionNumberPid = 7222;

		private const string YleOrganizationCode = "FIYLE";

		private static readonly Dictionary<string, string> OrganizationCodeMapping = new Dictionary<string, string>
		{
			{ YleOrganizationCode, "YLE" },
			{ "FIMTV", "MTV" },
			{ "FINENT", "NENT" },
			{ "FIC4", "Nelonen" }
		};

		private readonly Skyline.DataMiner.Core.DataMinerSystem.Common.IDmsTable synopsisTable;

		public EurovisionIntegration(Skyline.DataMiner.DeveloperCommunityLibrary.YLE.Utilities.Helpers helpers, IDms dms, IOrderManagerElement orderManagerElement) : base(helpers, dms, orderManagerElement)
		{
			synopsisTable = integrationElement.GetTable(SynopsesTablePid) ?? throw new Exception("Synopsis table could not be retrieved");
		}

		public override IntegrationType IntegrationType => IntegrationType.Eurovision;

		protected override string IntegrationElementId => orderManagerElement.EbuElementId;

		protected override string IntegrationText => "Automatically generated by Eurovision integration";

		public override void HandleUpdate(string id)
		{
			helpers.Log(nameof(EurovisionIntegration), nameof(HandleUpdate), "Handling update for Transmission Number: " + id);

			synopsis synopsis = RetrieveSynopsis(id);
			if (synopsis == null)
			{
				orderManagerElement.SendResponse(new IntegrationResponse(IntegrationType.Eurovision, id)
				{
					Status = IntegrationUpdateStatus.Failed,
					AdditionalInformation = "HandleUpdate|No action executed|Unable to retrieve or parse synopsis"
				});

				return;
			}

			Order order = null;
			if (synopsis.technicalSystems.FirstOrDefault(x => x.IsNewsTechnicalSystem) == null)
			{
				order = GenerateEbuOrder(synopsis);
			}
			else
			{
				// No order or note needed for fixed EBU news channels
				orderManagerElement.SendResponse(new IntegrationResponse(IntegrationType.Eurovision, id)
				{
					Status = IntegrationUpdateStatus.OK,
					AdditionalInformation = "HandleUpdate|No action required|Fixed news"
				});

				return;
			}

			if (order != null)
			{
				AddOrUpdateEurovisionOrder(id, order, synopsis);
			}
			else
			{
				var note = GenerateEbuNote(synopsis);
				AddOrUpdateEurovisionNote(note);
			}
		}

		/// <summary>
		/// Deserializes the content of the specified Synopsis XML file.
		/// </summary>
		/// <param name="synopsisFilePath">File path of the Synopsis XML file.</param>
		/// <returns>Deserialized content of the Synopsis XML file.</returns>
		private synopsis RetrieveSynopsis(string transmissionNumber)
		{
			if (String.IsNullOrWhiteSpace(transmissionNumber)) return null;

			var ebuElement = helpers.Engine.FindElementByKey(IntegrationElementId);
			if (ebuElement == null)
			{
				helpers.Log(nameof(EurovisionIntegration), nameof(RetrieveSynopsis), $"Unable to find the EBU element with ID: {IntegrationElementId}");
				return null;
			}

			if (!ebuElement.IsActive)
			{
				helpers.Log(nameof(EurovisionIntegration), nameof(RetrieveSynopsis), $"The EBU element with ID {IntegrationElementId} is inactive");
				return null;
			}

			var ebuManager = new EbuManager(helpers.Engine, ebuElement);
			var synopsisXml = ebuManager.GetSynopsis(transmissionNumber);
			if (synopsisXml == null)
			{
				return null;
			}

			return EbuManager.ParseSynopsis(synopsisXml);
		}

		#region Generate Services

		/// <summary>
		/// Generates a list of valid receptions from the Synopsis and their related contract.
		/// </summary>
		/// <param name="synopsis">Synopsis as received from Eurovision.</param>
		/// <returns>List of configured reception services and their contract.</returns>
		private IEnumerable<Tuple<Service, Contract>> GenerateReceptions(synopsis synopsis)
		{
			if (synopsis == null) throw new ArgumentNullException(nameof(synopsis));

			var receptions = new List<Tuple<Service, Contract>>();
			foreach (var destination in synopsis.destinations)
			{
				var contract = GetValidContractForDestination(destination, synopsis.StartDateTime, synopsis.EndDateTime);
				if (contract == null) continue;

				var receptionsForDestination = GenerateReceptionsForDestination(synopsis, destination);
				foreach (var reception in receptionsForDestination)
				{
					bool receptionAlreadyExists = receptions.Any(s => DoServicesMatch(s.Item1, reception, IgnoredItems.None));
					if (!receptionAlreadyExists) receptions.Add(new Tuple<Service, Contract>(reception, contract));
				}
			}

			return receptions;
		}

		private IEnumerable<Service> GenerateReceptionsForDestination(synopsis synopsis, synopsisDestination destination)
		{
			var receptions = new List<Service>();
			foreach (var technicalSystem in synopsis.technicalSystems)
			{
				bool technicalSystemIsLinkedToDestination = technicalSystem != null && technicalSystem.technicalSystemId == destination.technicalSystemId;
				if (!technicalSystemIsLinkedToDestination) continue;

				receptions.AddRange(GenerateReceptionsForTechnicalSystem(synopsis, destination, technicalSystem));
			}

			return receptions;
		}

		private Contract GetValidContractForDestination(synopsisDestination destination, DateTime startTime, DateTime endTime)
		{
			// Check Destination.OrganizationCode field
			string organizationCode = OrganizationCodeMapping.Keys.FirstOrDefault(x => destination.organizationCode.ToUpper().Contains(x));

			// Check broadCastCenterCode
			if (String.IsNullOrWhiteSpace(organizationCode) && !String.IsNullOrWhiteSpace(destination.broadcastCenterCode) && destination.broadcastCenterCode.ToUpper().Contains(YleOrganizationCode)) organizationCode = YleOrganizationCode;

			// Check broadCastCenterCodeVia
			if (String.IsNullOrWhiteSpace(organizationCode) && !String.IsNullOrWhiteSpace(destination.broadcastCenterCodeVia) && destination.broadcastCenterCodeVia.ToUpper().Contains(YleOrganizationCode)) organizationCode = YleOrganizationCode;

			if (String.IsNullOrWhiteSpace(organizationCode)) return null; // No supported organisation

			string companyName = helpers.ContractManager.GetAllCompanies().FirstOrDefault(x => x.IndexOf(OrganizationCodeMapping[organizationCode], StringComparison.InvariantCultureIgnoreCase) >= 0);
			if (String.IsNullOrWhiteSpace(companyName))
			{
				return null;
			}

			ExternalCompanyResponse companyResponse = helpers.ContractManager.RequestCompanyContractDetails(companyName);
			if (companyResponse == null)
			{
				return null;
			}

			Contract baseContract = companyResponse.Contracts.FirstOrDefault(x => x.Type == ContractType.BaseContract);
			if (baseContract == null)
			{
				return null;
			}

			if (baseContract.Start > startTime || baseContract.End < endTime)
			{
				return null;
			}

			return baseContract;
		}

		private IEnumerable<Service> GenerateReceptionsForTechnicalSystem(synopsis synopsis, synopsisDestination destination, synopsisTechnicalSystem technicalSystem)
		{
			var receptions = new List<Service>();

			if (TryCreateSatelliteReception(synopsis, destination, technicalSystem, out var satelliteReception))
			{
				receptions.Add(satelliteReception);
			}

			if (synopsis.routings == null) return receptions;

			// Check if Technical System defines Fixed Line ACES RX
			var acesRegex = new Regex("ACE TO YLE 0[12]");
			var acesRoute = synopsis.routings.FirstOrDefault(x => acesRegex.IsMatch(x.circuit));
			var containsAceToYleRoutings = (acesRoute != null);

			if (containsAceToYleRoutings)
			{
				// Generate Fixed Line EBU ACES EBU Reception
				receptions.Add(GenerateFixedLineEbuRxService(synopsis, technicalSystem, acesRoute));
			}

			// Check if Technical System defines Fixed Line Nordic Ring RX
			var nordicRingRegex = new Regex("(JO01|JO02|FO03|FO04)HLKI");
			var nordicRingRoute = synopsis.routings.FirstOrDefault(x => nordicRingRegex.IsMatch(x.circuit));
			var containsNordicRingRoutings = (nordicRingRoute != null);

			if (containsNordicRingRoutings)
			{
				// Generate Fixed Line EBU Nordic Ring Reception
				receptions.Add(GenerateFixedLineEbuRxService(synopsis, technicalSystem, nordicRingRoute));
			}

			// Check if Routing information contains HLKI fiber ports for FIBER RX
			var fiberPortsRegex = new Regex("HLKI");
			var containsFiberPorts = synopsis.routings.Any(x => fiberPortsRegex.IsMatch(x.circuit));

			if (containsFiberPorts && !containsAceToYleRoutings && !containsNordicRingRoutings)
			{
				// Generate Fiber Reception if no Fixed Line Receptions available
				receptions.Add(GenerateFullCapacityFiberRxService(synopsis, technicalSystem));
			}

			return receptions;
		}

		private bool TryCreateSatelliteReception(synopsis synopsis, synopsisDestination destination, synopsisTechnicalSystem technicalSystem, out Service satelliteReception)
		{
			if (synopsis == null) throw new ArgumentNullException(nameof(synopsis));
			if (destination == null) throw new ArgumentNullException(nameof(destination));
			if (technicalSystem == null) throw new ArgumentNullException(nameof(technicalSystem));

			satelliteReception = null;

			var downlinkFrequencyProfileParameter = helpers.ProfileManager.GetProfileParameter(SrmConfiguration.DownlinkFrequencyProfileParameterName);
			if (downlinkFrequencyProfileParameter == null) throw new ProfileParameterNotFoundException(SrmConfiguration.DownlinkFrequencyProfileParameterName);

			double minFrequencyRange = downlinkFrequencyProfileParameter.RangeMin;
			double maxFrequencyRange = downlinkFrequencyProfileParameter.RangeMax;
			bool isValidFrequency = Double.TryParse(technicalSystem.downlink.frequency, NumberStyles.Any, CultureInfo.InvariantCulture, out double frequency) && frequency >= minFrequencyRange && frequency <= maxFrequencyRange;

			// Check if the Channel Code is valid
			bool hasValidChannelCode = String.IsNullOrEmpty(technicalSystem.channelCode) || !technicalSystem.channelCode.Equals("FINE", StringComparison.InvariantCultureIgnoreCase);

			if (hasValidChannelCode && isValidFrequency)
			{
				satelliteReception = GenerateSatelliteRxService(synopsis, destination, technicalSystem);
				return true;
			}

			return false;
		}

		private Service GenerateSatelliteRxService(synopsis synopsis, synopsisDestination destination, synopsisTechnicalSystem technicalSystem)
		{
			// Init Service
			Service service = GenerateDefaultIntegrationService(SatelliteRxServiceDefinition, synopsis.StartDateTime, synopsis.EndDateTime);
			service.EurovisionTransmissionNumber = synopsis.transmissionNo;
			service.EurovisionTechnicalSystemId = technicalSystem.technicalSystemId;
			service.EurovisionDestinationId = destination.destinationId;
			service.IsEurovisionMultiFeedService = !String.IsNullOrWhiteSpace(technicalSystem.ioMuxName); // Indicates that this is a multiplexed signal

			// Assign Satellite resource - retrieve from Reception.Satellite.Satellite resource pool
			FunctionResource receptionSatellite = GetSatelliteRxResource(technicalSystem.system.name);
			Function satelliteFunction = service.Functions.FirstOrDefault(x => x.Name.Equals("satellite", StringComparison.InvariantCultureIgnoreCase));
			satelliteFunction.Resource = receptionSatellite;
			satelliteFunction.EnforceSelectedResource = true;

			// Configure LBAND Matrix Input
			Function lBandMatrixInputFunction = service.Functions.FirstOrDefault(x => x.Name.Equals("matrix input lband", StringComparison.InvariantCultureIgnoreCase));
			ConfigureSatelliteRxLBandMatrixInputFunction(lBandMatrixInputFunction, technicalSystem);

			// Configure LBAND Matrix Output
			Function lBandMatrixOutputFunction = service.Functions.FirstOrDefault(x => x.Name.Equals("matrix output lband", StringComparison.InvariantCultureIgnoreCase));
			ConfigureSatelliteRxLBandMatrixOutputFunction(lBandMatrixOutputFunction, technicalSystem);

			// Configure Demodulating Function
			Function demodulatingFunction = service.Functions.FirstOrDefault(x => x.Name.Equals("demodulating", StringComparison.InvariantCultureIgnoreCase));
			ConfigureSatelliteRxDemodulatingFunction(demodulatingFunction, technicalSystem);

			// Configure ASI Matrix Input/Output -> no profile parameters

			// Configure Decoding Function
			Function decodingFunction = service.Functions.FirstOrDefault(x => x.Name.Equals("decoding", StringComparison.InvariantCultureIgnoreCase));
			ConfigureSatelliteRxDecodingFunction(decodingFunction, destination, technicalSystem);

			// Configure Audio Channels
			ConfigureAudioChannels(service.AudioChannelConfiguration, technicalSystem);

			return service;
		}

		private FunctionResource GetSatelliteRxResource(string systemName)
		{
			var receptionSatelliteResourcePool = helpers.ResourceManager.GetResourcePools(new Skyline.DataMiner.Net.Messages.ResourcePool { Name = SrmConfiguration.ReceptionSatelliteResourcePool }).FirstOrDefault();
			if (receptionSatelliteResourcePool == null) throw new ResourcePoolNotFoundException(SrmConfiguration.ReceptionSatelliteResourcePool);

			string satelliteName;
			if (!ResourceMapping.Satellites.TryGetValue(systemName, out satelliteName))
			{
				// Check if system name is present in the list of predefined satellites
				satelliteName = systemName;
			}

			var resource = helpers.ResourceManager.GetResources(FunctionResourceExposers.PoolGUIDs.Contains(receptionSatelliteResourcePool.GUID)).FirstOrDefault(x => x.Name.StartsWith(satelliteName, StringComparison.InvariantCultureIgnoreCase));
			if (resource == null) throw new ResourceNotFoundException(satelliteName);

			return resource as FunctionResource;
		}

		private FunctionResource GetResource(string resourcePoolName, string resourceName)
		{
			var resourcePool = helpers.ResourceManager.GetResourcePools(new Skyline.DataMiner.Net.Messages.ResourcePool { Name = resourcePoolName }).FirstOrDefault();
			if (resourcePool == null) throw new ResourcePoolNotFoundException(resourcePoolName);

			var resource = helpers.ResourceManager.GetResources(FunctionResourceExposers.PoolGUIDs.Contains(resourcePool.GUID)).FirstOrDefault(x => x.Name.Contains(resourceName));
			if (resource == null) throw new ResourceNotFoundException(resourceName);

			return resource as FunctionResource;
		}

		private static void ConfigureSatelliteRxLBandMatrixInputFunction(Function function, synopsisTechnicalSystem technicalSystem)
		{
			// Downlink Frequency
			ProfileParameter downLinkFrequencyProfileParameter = function.Parameters.FirstOrDefault(x => x.Name == SrmConfiguration.DownlinkFrequencyProfileParameterName);
			if (downLinkFrequencyProfileParameter == null) throw new ProfileParameterNotFoundException(SrmConfiguration.DownlinkFrequencyProfileParameterName);
			if (!Double.TryParse(technicalSystem.downlink.frequency, NumberStyles.Any, CultureInfo.InvariantCulture, out double frequency))
			{
				throw new InvalidProfileParameterValueException(downLinkFrequencyProfileParameter.Name, technicalSystem.downlink.frequency);
			}

			downLinkFrequencyProfileParameter.Value = frequency;

			// Polarization
			ProfileParameter polarizationProfileParameter = function.Parameters.FirstOrDefault(x => x.Name == SrmConfiguration.PolarizationProfileParameterName);
			if (polarizationProfileParameter == null) throw new ProfileParameterNotFoundException(SrmConfiguration.PolarizationProfileParameterName);
			string polarity = polarizationProfileParameter.Discreets.Select(x => x.InternalValue).FirstOrDefault(x => x.StartsWith(technicalSystem.downlink.polarity, StringComparison.InvariantCultureIgnoreCase));
			if (polarity == null)
			{
				throw new InvalidProfileParameterValueException(polarizationProfileParameter.Name, technicalSystem.downlink.polarity);
			}

			polarizationProfileParameter.Value = polarity;
		}

		private static void ConfigureSatelliteRxLBandMatrixOutputFunction(Function function, synopsisTechnicalSystem technicalSystem)
		{
			// Downlink Frequency
			ProfileParameter downLinkFrequencyProfileParameter = function.Parameters.FirstOrDefault(x => x.Name == SrmConfiguration.DownlinkFrequencyProfileParameterName);
			if (downLinkFrequencyProfileParameter == null) throw new ProfileParameterNotFoundException(SrmConfiguration.DownlinkFrequencyProfileParameterName);
			if (!Double.TryParse(technicalSystem.downlink.frequency, NumberStyles.Any, CultureInfo.InvariantCulture, out double frequency))
			{
				throw new InvalidProfileParameterValueException(downLinkFrequencyProfileParameter.Name, technicalSystem.downlink.frequency);
			}

			downLinkFrequencyProfileParameter.Value = frequency;

			// Polarization
			ProfileParameter polarizationProfileParameter = function.Parameters.FirstOrDefault(x => x.Name == SrmConfiguration.PolarizationProfileParameterName);
			if (polarizationProfileParameter == null) throw new ProfileParameterNotFoundException(SrmConfiguration.PolarizationProfileParameterName);
			string polarity = polarizationProfileParameter.Discreets.Select(x => x.InternalValue).FirstOrDefault(x => x.StartsWith(technicalSystem.downlink.polarity, StringComparison.InvariantCultureIgnoreCase));
			if (polarity == null)
			{
				throw new InvalidProfileParameterValueException(polarizationProfileParameter.Name, technicalSystem.downlink.polarity);
			}

			polarizationProfileParameter.Value = polarity;

			StreamName streamName;
			try
			{
				streamName = new StreamName(technicalSystem.streamName);
			}
			catch (Exception e)
			{
				throw new ArgumentException("Unable to parse Stream Name", e);
			}

			// Modulation Standard
			ProfileParameter modulationStandardProfileParameter = function.Parameters.FirstOrDefault(x => x.Name == SrmConfiguration.ModulationStandardProfileParameterName);
			if (modulationStandardProfileParameter == null) throw new ProfileParameterNotFoundException(SrmConfiguration.ModulationStandardProfileParameterName);
			string modulationStandard = modulationStandardProfileParameter.Discreets.Select(x => x.InternalValue).FirstOrDefault(x => x.Replace("-", String.Empty).Equals(streamName.ModulationStandard, StringComparison.InvariantCultureIgnoreCase));
			if (modulationStandard == null)
			{
				throw new InvalidProfileParameterValueException(modulationStandardProfileParameter.Name, streamName.ModulationStandard);
			}

			modulationStandardProfileParameter.Value = modulationStandard;

			// Encryption Type
			ProfileParameter encryptionTypeProfileParameter = function.Parameters.FirstOrDefault(x => x.Name == SrmConfiguration.EncryptionTypeProfileParameterName);
			if (encryptionTypeProfileParameter == null) throw new ProfileParameterNotFoundException(SrmConfiguration.EncryptionTypeProfileParameterName);
			string encryptionType = encryptionTypeProfileParameter.Discreets.Select(x => x.InternalValue).FirstOrDefault(x => x.Equals(technicalSystem.encryptionTypeCode, StringComparison.InvariantCultureIgnoreCase));
			if (encryptionType == null)
			{
				// No encryption required
				encryptionTypeProfileParameter.Value = SrmConfiguration.EncryptionTypeFreeProfileParameterValue;
			}
			else
			{
				// Use encryption key from technical system or destination
				encryptionTypeProfileParameter.Value = encryptionType;
			}
		}

		private static void ConfigureSatelliteRxDemodulatingFunction(Function function, synopsisTechnicalSystem technicalSystem)
		{
			ProfileParameter downLinkFrequencyProfileParameter = function.Parameters.FirstOrDefault(x => x.Name == SrmConfiguration.DownlinkFrequencyProfileParameterName);
			if (downLinkFrequencyProfileParameter == null) throw new ProfileParameterNotFoundException(SrmConfiguration.DownlinkFrequencyProfileParameterName);
			if (!Double.TryParse(technicalSystem.downlink.frequency, NumberStyles.Any, CultureInfo.InvariantCulture, out double frequency))
			{
				throw new InvalidProfileParameterValueException(downLinkFrequencyProfileParameter.Name, technicalSystem.downlink.frequency);
			}

			downLinkFrequencyProfileParameter.Value = frequency;

			ProfileParameter polarizationProfileParameter = function.Parameters.FirstOrDefault(x => x.Name == SrmConfiguration.PolarizationProfileParameterName);
			if (polarizationProfileParameter == null) throw new ProfileParameterNotFoundException(SrmConfiguration.PolarizationProfileParameterName);
			string polarity = polarizationProfileParameter.Discreets.Select(x => x.InternalValue).FirstOrDefault(x => x.StartsWith(technicalSystem.downlink.polarity, StringComparison.InvariantCultureIgnoreCase));
			if (polarity == null)
			{
				throw new InvalidProfileParameterValueException(polarizationProfileParameter.Name, technicalSystem.downlink.polarity);
			}

			polarizationProfileParameter.Value = polarity;

			StreamName streamName;
			try
			{
				streamName = new StreamName(technicalSystem.streamName);
			}
			catch (Exception e)
			{
				throw new ArgumentException("Unable to parse Stream Name", e);
			}

			ProfileParameter fecProfileParameter = function.Parameters.FirstOrDefault(x => x.Name == SrmConfiguration.FecProfileParameterName);
			if (fecProfileParameter == null) throw new ProfileParameterNotFoundException(SrmConfiguration.FecProfileParameterName);
			if (!fecProfileParameter.Discreets.Any(x => x.InternalValue.Equals(streamName.FEC)))
			{
				throw new InvalidProfileParameterValueException(fecProfileParameter.Name, streamName.FEC);
			}

			fecProfileParameter.Value = streamName.FEC;

			ProfileParameter symbolRateProfileParameter = function.Parameters.FirstOrDefault(x => x.Name == SrmConfiguration.SymbolRateProfileParameterName);
			if (symbolRateProfileParameter == null) throw new ProfileParameterNotFoundException(SrmConfiguration.SymbolRateProfileParameterName);
			if (streamName.SymbolRate < symbolRateProfileParameter.RangeMin || streamName.SymbolRate > symbolRateProfileParameter.RangeMax)
			{
				throw new InvalidProfileParameterValueException(symbolRateProfileParameter.Name, streamName.SymbolRate);
			}

			symbolRateProfileParameter.Value = Math.Round(streamName.SymbolRate, symbolRateProfileParameter.Decimals);

			ProfileParameter modulationStandardProfileParameter = function.Parameters.FirstOrDefault(x => x.Name == SrmConfiguration.ModulationStandardProfileParameterName);
			if (modulationStandardProfileParameter == null) throw new ProfileParameterNotFoundException(SrmConfiguration.ModulationStandardProfileParameterName);
<<<<<<< HEAD
			string modulationStandard = modulationStandardProfileParameter.Discreets.Select(x => x.InternalValue).FirstOrDefault(x => x.Replace("-", String.Empty).Equals(streamName.ModulationStandard, StringComparison.InvariantCultureIgnoreCase));
=======
			
			string modulationStandard = modulationStandardProfileParameter.Discreets.Select(x => x.InternalValue).FirstOrDefault(x => x.Equals(streamName.ModulationStandard, StringComparison.InvariantCultureIgnoreCase));
>>>>>>> 9ca49014 (Removed some logging. Fixed same issue for EBU Satellite Transmissions.)
			if (modulationStandard == null)
			{
				throw new InvalidProfileParameterValueException(modulationStandardProfileParameter.Name, streamName.ModulationStandard);
			}

			modulationStandardProfileParameter.Value = modulationStandard;

			ProfileParameter modulationProfileParameter = function.Parameters.FirstOrDefault(x => x.Name == SrmConfiguration.ModulationProfileParameterName);
			if (modulationProfileParameter == null) throw new ProfileParameterNotFoundException(SrmConfiguration.ModulationProfileParameterName);
			string modulation = modulationProfileParameter.Discreets.Select(x => x.InternalValue).FirstOrDefault(x => x.Equals(streamName.Modulation, StringComparison.InvariantCultureIgnoreCase));
			if (modulation == null)
			{
				throw new InvalidProfileParameterValueException(modulationProfileParameter.Name, streamName.Modulation);
			}

			modulationProfileParameter.Value = modulation;
		}

		private static void ConfigureSatelliteRxDecodingFunction(Function function, synopsisDestination destination, synopsisTechnicalSystem technicalSystem)
		{
			StreamName streamName;
			try
			{
				streamName = new StreamName(technicalSystem.streamName);
			}
			catch (Exception e)
			{
				throw new ArgumentException("Unable to parse Stream Name", e);
			}

			// Encoding
			ProfileParameter encodingProfileParameter = function.Parameters.FirstOrDefault(x => x.Name == SrmConfiguration.EncodingProfileParameterName);
			if (encodingProfileParameter == null) throw new ProfileParameterNotFoundException(SrmConfiguration.EncodingProfileParameterName);
			string encoding = encodingProfileParameter.Discreets.Select(x => x.InternalValue).FirstOrDefault(x => x.Equals(streamName.Encoding));
			if (encoding == null)
			{
				throw new InvalidProfileParameterValueException(String.Format("{0} is not a valid Encoding value", streamName.Encoding));
			}

			encodingProfileParameter.Value = encoding;

			// Encryption Key
			ProfileParameter encryptionKeyProfileParameter = function.Parameters.FirstOrDefault(x => x.Name == SrmConfiguration.EncryptionKeyProfileParameterName);
			if (encryptionKeyProfileParameter == null) throw new ProfileParameterNotFoundException(SrmConfiguration.EncryptionKeyProfileParameterName);

			// Encryption Type
			ProfileParameter encryptionTypeProfileParameter = function.Parameters.FirstOrDefault(x => x.Name == SrmConfiguration.EncryptionTypeProfileParameterName);
			if (encryptionTypeProfileParameter == null) throw new ProfileParameterNotFoundException(SrmConfiguration.EncryptionTypeProfileParameterName);
			string encryptionType = encryptionTypeProfileParameter.Discreets.Select(x => x.InternalValue).FirstOrDefault(x => x.Equals(technicalSystem.encryptionTypeCode, StringComparison.InvariantCultureIgnoreCase));
			if (encryptionType == null)
			{
				// No encryption required
				encryptionTypeProfileParameter.Value = SrmConfiguration.EncryptionTypeFreeProfileParameterValue;
				encryptionKeyProfileParameter.Value = String.Empty;
			}
			else
			{
				// Use encryption key from technical system or destination
				encryptionTypeProfileParameter.Value = encryptionType;
				if (!String.IsNullOrWhiteSpace(destination.encryptionKey))
				{
					encryptionKeyProfileParameter.Value = destination.encryptionKey;
				}
				else if (!String.IsNullOrWhiteSpace(technicalSystem.encryptionKey))
				{
					encryptionKeyProfileParameter.Value = technicalSystem.encryptionKey;
				}
				else
				{
					// Don't assign encryption key
				}
			}

			// Video Format
			ProfileParameter videoFormatProfileParameter = function.Parameters.FirstOrDefault(x => x.Name == SrmConfiguration.VideoFormatProfileParameterName);
			if (videoFormatProfileParameter == null) throw new ProfileParameterNotFoundException(SrmConfiguration.VideoFormatProfileParameterName);
			ConfigureVideoFormatProfileParameter(videoFormatProfileParameter, technicalSystem);

			// Service Selection
			var serviceSelectionProfileParameter = function.Parameters.FirstOrDefault(p => p.Id == ProfileParameterGuids.ServiceSelection);
			if (serviceSelectionProfileParameter == null) throw new ProfileParameterNotFoundException(ProfileParameterGuids.ServiceSelection);
			serviceSelectionProfileParameter.Value = technicalSystem.ioMuxName;
		}

		private Service GenerateFullCapacityFiberRxService(synopsis synopsis, synopsisTechnicalSystem technicalSystem)
		{
			// Init Service
			Service service = GenerateDefaultIntegrationService(FiberRxFullCapacityServiceDefinition, synopsis.StartDateTime, synopsis.EndDateTime);
			service.EurovisionTransmissionNumber = synopsis.transmissionNo;
			service.EurovisionTechnicalSystemId = technicalSystem.technicalSystemId;

			// Configure Source Function
			Function sourceFunction = service.Functions.FirstOrDefault();

			// Configure Source Function - Video Format
			ProfileParameter videoFormatProfileParameter = sourceFunction.Parameters.FirstOrDefault(x => x.Name == SrmConfiguration.VideoFormatProfileParameterName);
			ConfigureVideoFormatProfileParameter(videoFormatProfileParameter, technicalSystem);

			// Configure Audio Channels
			ConfigureAudioChannels(service.AudioChannelConfiguration, technicalSystem);

			return service;
		}

		private Service GenerateFixedLineEbuRxService(synopsis synopsis, synopsisTechnicalSystem technicalSystem, synopsisRouting routing)
		{
			string locationName;
			FunctionResource resource;

			if (!TryGetFixedLineEbuRxLocationAndResource(routing, out locationName, out resource))
			{
				return null;
			}

			// Init Service
			Service service = GenerateDefaultIntegrationService(FixedLineEbuRxServiceDefinition, synopsis.StartDateTime, synopsis.EndDateTime);
			service.EurovisionTransmissionNumber = synopsis.transmissionNo;
			service.EurovisionTechnicalSystemId = technicalSystem.technicalSystemId;

			// Configure Source Function
			Function sourceFunction = service.Functions.FirstOrDefault();

			// Configure Fixed Line EBU Source Location
			ProfileParameter ebuLocationProfileParameter = sourceFunction?.Parameters.FirstOrDefault(x => x.Name == SrmConfiguration.FixedLineEbuSourceLocationProfileParameterName);
			if (ebuLocationProfileParameter == null) throw new ProfileParameterNotFoundException(SrmConfiguration.FixedLineEbuSourceLocationProfileParameterName);
			ebuLocationProfileParameter.Value = locationName;

			// Configure Source Function - Video Format
			ProfileParameter videoFormatProfileParameter = sourceFunction.Parameters.FirstOrDefault(x => x.Name == SrmConfiguration.VideoFormatProfileParameterName);
			ConfigureVideoFormatProfileParameter(videoFormatProfileParameter, technicalSystem);

			// Configure Audio Channels
			ConfigureAudioChannels(service.AudioChannelConfiguration, technicalSystem);

			// Assign Resource
			sourceFunction.Resource = resource;
			sourceFunction.EnforceSelectedResource = true;

			return service;
		}

		private bool TryGetFixedLineEbuRxLocationAndResource(synopsisRouting routing, out string location, out FunctionResource resource)
		{
			location = null;
			resource = null;

			List<Tuple<Regex, string, string>> routingMapping = new List<Tuple<Regex, string, string>>
			{
				{ new Tuple<Regex, string, string>(new Regex("ACE TO YLE 01"), SrmConfiguration.FixedLineEbuSourceLocationAcesEbuProfileParameterValue, "SDI Aces to YLE 01.Fixed Line") },
				{ new Tuple<Regex, string, string>(new Regex("ACE TO YLE 02"), SrmConfiguration.FixedLineEbuSourceLocationAcesEbuProfileParameterValue, "SDI Aces to YLE 01.Fixed Line") },
				{ new Tuple<Regex, string, string>(new Regex("JO01HLKI"), SrmConfiguration.FixedLineEbuSourceLocationNordicRingProfileParameterValue, "JO 01.Fixed Line") },
				{ new Tuple<Regex, string, string>(new Regex("JO02HLKI"), SrmConfiguration.FixedLineEbuSourceLocationNordicRingProfileParameterValue, "JO 02.Fixed Line") },
				{ new Tuple<Regex, string, string>(new Regex("FO03HLKI"), SrmConfiguration.FixedLineEbuSourceLocationNordicRingProfileParameterValue, "FO 03.Fixed Line") },
				{ new Tuple<Regex, string, string>(new Regex("FO04HLKI"), SrmConfiguration.FixedLineEbuSourceLocationNordicRingProfileParameterValue, "FO 04.Fixed Line") },
			};

			string resourceName = null;
			foreach (var tuple in routingMapping)
			{
				if (tuple.Item1.IsMatch(routing.circuit))
				{
					location = tuple.Item2;
					resourceName = tuple.Item3;
					break;
				}
			}

			if (location == null || resourceName == null) return false;

			resource = GetResource("Reception.Fixed Line.Fixed Line EBU", resourceName);
			return true;
		}

		/// <summary>
		/// Generates a list of valid transmissions from the Synopsis.
		/// </summary>
		/// <param name="synopsis">Synopsis as received from Eurovision.</param>
		/// <returns>List of configured transmission services.</returns>
		private IEnumerable<Service> GenerateTransmissions(synopsis synopsis)
		{
			List<Service> transmissions = new List<Service>();
			synopsisOrigin yleTransmissionOrigin = null;
			foreach (synopsisOrigin origin in synopsis.origins)
			{
				bool organizationCodeContainsName = !String.IsNullOrWhiteSpace(origin.organizationCode) && origin.organizationCode.IndexOf(YleOrganizationCode, StringComparison.InvariantCultureIgnoreCase) >= 0;
				bool broadcastCenterCodeContainsName = !String.IsNullOrWhiteSpace(origin.broadcastCenterCode) && origin.broadcastCenterCode.IndexOf(YleOrganizationCode, StringComparison.InvariantCultureIgnoreCase) >= 0;
				bool broadcastCenterCodeViaContainsName = !String.IsNullOrWhiteSpace(origin.broadcastCenterCodeVia) && origin.broadcastCenterCodeVia.IndexOf(YleOrganizationCode, StringComparison.InvariantCultureIgnoreCase) >= 0;
				if (organizationCodeContainsName || broadcastCenterCodeContainsName || broadcastCenterCodeViaContainsName)
				{
					yleTransmissionOrigin = origin;
					break;
				}
			}

			if (yleTransmissionOrigin == null)
			{
				return transmissions;
			}

			foreach (synopsisTechnicalSystem technicalSystem in synopsis.technicalSystems)
			{
				foreach (Service transmission in GenerateTransmissionsForTechnicalSystem(synopsis, yleTransmissionOrigin, technicalSystem))
				{
					if (!transmissions.Any(x => DoServicesMatch(x, transmission, IgnoredItems.None))) transmissions.Add(transmission);
				}
			}

			return transmissions;
		}

		private IEnumerable<Service> GenerateTransmissionsForTechnicalSystem(synopsis synopsis, synopsisOrigin origin, synopsisTechnicalSystem technicalSystem)
		{
			// SAT TX - Check if frequency is valid
			ProfileParameter uplinkFrequencyProfileParameter = helpers.ProfileManager.GetProfileParameter(SrmConfiguration.UplinkFrequencyProfileParameterName);
			if (uplinkFrequencyProfileParameter == null) throw new ProfileParameterNotFoundException(SrmConfiguration.UplinkFrequencyProfileParameterName);

			double minFrequencyRange = uplinkFrequencyProfileParameter.RangeMin;
			double maxFrequencyRange = uplinkFrequencyProfileParameter.RangeMax;
			bool isValidFrequency = Double.TryParse(technicalSystem.uplink.frequency, NumberStyles.Any, CultureInfo.InvariantCulture, out double frequency) && frequency >= minFrequencyRange && frequency <= maxFrequencyRange;

			// SAT TX - Check if Channel Code is valid
			bool channelCodeEqualsFine = technicalSystem.channelCode.Equals("FINE", StringComparison.InvariantCultureIgnoreCase);

			// SAT TX - Check if Uplink Code does not include ACE HLKI
			bool uplinkCodeContainsAceHlki = technicalSystem.uplink.code.IndexOf("ACE HLKI", StringComparison.InvariantCultureIgnoreCase) >= 0;

			// Fixed Line TX - Check if Technical System defines Fixed Line ACES TX
			Regex acesRegex = new Regex("YLE TO ACE 0[12]");
			var acesRoute = synopsis.routings.FirstOrDefault(x => acesRegex.IsMatch(x.circuit));
			bool containsYleToAceRoutings = (acesRoute != null);

			// Fixed Line TX - Check if Technical System defines Fixed Line Nordic Ring TX
			Regex nordicRingRegex = new Regex("(JI01|JI02|FI03|FI01)HLKI");
			var nordicRingRoute = synopsis.routings.FirstOrDefault(x => nordicRingRegex.IsMatch(x.circuit));
			bool containsNordicRingRoutings = (nordicRingRoute != null);

			// Fiber TX - Check if Routing information contains HLKI fiber ports
			Regex fiberPortsRegex = new Regex("HLKI"); // old regex: new Regex("O0[0-9]*HLKI");
			bool containsFiberPorts = synopsis.routings.Any(x => fiberPortsRegex.IsMatch(x.circuit));

			List<Service> transmissions = new List<Service>();

			bool generateSatelliteTransmission = !channelCodeEqualsFine && !uplinkCodeContainsAceHlki && isValidFrequency;
			if (generateSatelliteTransmission)
			{
				// Generate Satelllite Transmission
				transmissions.Add(GenerateSatelliteTxService(synopsis, origin, technicalSystem));
			}

			if (containsYleToAceRoutings)
			{
				// Generate Fixed Line ACES Destination
				transmissions.Add(GenerateEbuDestinationService(synopsis, technicalSystem, acesRoute));
			}
			else if (containsNordicRingRoutings)
			{
				// Generate Fixed Line Nordic Ring Destination
				transmissions.Add(GenerateEbuDestinationService(synopsis, technicalSystem, nordicRingRoute));
			}
			else if (containsFiberPorts)
			{
				// Generate Fiber Transmission
				transmissions.Add(GenerateFullCapacityFiberTxService(synopsis, technicalSystem));
			}
			else
			{
				// No services to add
			}

			return transmissions;
		}

		private Service GenerateSatelliteTxService(synopsis synopsis, synopsisOrigin origin, synopsisTechnicalSystem technicalSystem)
		{
			// Init Service
			Service service = GenerateDefaultIntegrationService(SatelliteTxServiceDefinition, synopsis.StartDateTime, synopsis.EndDateTime);
			service.EurovisionTransmissionNumber = synopsis.transmissionNo;
			service.EurovisionTechnicalSystemId = technicalSystem.technicalSystemId;

			// Configure Encoding Function
			Function encodingFunction = service.Functions.FirstOrDefault(x => x.Name.Equals("generic encoding", StringComparison.InvariantCultureIgnoreCase));
			ConfigureSatelliteTxEncodingFunction(encodingFunction, technicalSystem);

			// Configure Modulating Function
			Function modulatingFunction = service.Functions.FirstOrDefault(x => x.Name.Equals("generic modulating", StringComparison.InvariantCultureIgnoreCase));
			ConfigureSatelliteTxModulatingFunction(modulatingFunction, origin, technicalSystem);

			// Assign Satellite resource - retrieve from Transmission.Satellite.Satellite resource pool
			FunctionResource transmissionSatellite = GetSatelliteTxResource(technicalSystem.system.name);
			Function satelliteFunction = service.Functions.FirstOrDefault(x => x.Name.Equals("satellite", StringComparison.InvariantCultureIgnoreCase));
			satelliteFunction.Resource = transmissionSatellite;
			satelliteFunction.EnforceSelectedResource = true;

			// Configure Audio Channels
			ConfigureAudioChannels(service.AudioChannelConfiguration, technicalSystem);

			return service;
		}

		private static void ConfigureSatelliteTxEncodingFunction(Function function, synopsisTechnicalSystem technicalSystem)
		{
			StreamName streamName;
			try
			{
				streamName = new StreamName(technicalSystem.streamName);
			}
			catch (Exception e)
			{
				throw new ArgumentException("Unable to parse Stream Name", e);
			}

			// Encoding
			ProfileParameter encodingProfileParameter = function.Parameters.FirstOrDefault(x => x.Name == SrmConfiguration.EncodingProfileParameterName);
			if (encodingProfileParameter == null) throw new ProfileParameterNotFoundException(SrmConfiguration.EncodingProfileParameterName);
			string encoding = encodingProfileParameter.Discreets.Select(x => x.InternalValue).FirstOrDefault(x => x.Equals(streamName.Encoding));
			if (encoding == null) throw new InvalidProfileParameterValueException(String.Format("{0} is not a valid Encoding value", streamName.Encoding));
			encodingProfileParameter.Value = encoding;

			// Video Format
			ProfileParameter videoFormatProfileParameter = function.Parameters.FirstOrDefault(x => x.Name == SrmConfiguration.VideoFormatProfileParameterName);
			if (videoFormatProfileParameter == null) throw new ProfileParameterNotFoundException(SrmConfiguration.VideoFormatProfileParameterName);
			ConfigureVideoFormatProfileParameter(videoFormatProfileParameter, technicalSystem);
		}

		private static void ConfigureSatelliteTxModulatingFunction(Function function, synopsisOrigin origin, synopsisTechnicalSystem technicalSystem)
		{
			// Uplink Frequency
			ConfigureSatelliteTxModulatingFunctionUplinkFrequency(function, technicalSystem);

			// Polarization
			ConfigureSatelliteTxModulatingFunctionPolarization(function, technicalSystem);

			StreamName streamName;
			try
			{
				streamName = new StreamName(technicalSystem.streamName);
			}
			catch (Exception e)
			{
				throw new ArgumentException("Unable to parse Stream Name", e);
			}

			// FEC
			ConfigureSatelliteTxModulatingFunctionFec(function, streamName);

			// Symbol Rate
			ConfigureSatelliteTxModulatingFunctionSymbolRate(function, streamName);

			// Modulation Standard
			ConfigureSatelliteTxModulatingFunctionModulationStandard(function, streamName);

			// Modulation
			ConfigureSatelliteTxModulatingFunctionModulation(function, streamName);

			// Encryption Type and Encryption Key
			ConfigureSatelliteTxModulatingFunctionEncryption(function, origin, technicalSystem);
		}

		private static void ConfigureSatelliteTxModulatingFunctionUplinkFrequency(Function function, synopsisTechnicalSystem technicalSystem)
		{
			ProfileParameter upLinkFrequencyProfileParameter = function.Parameters.FirstOrDefault(x => x.Name == SrmConfiguration.UplinkFrequencyProfileParameterName);
			if (upLinkFrequencyProfileParameter == null) throw new ProfileParameterNotFoundException(SrmConfiguration.UplinkFrequencyProfileParameterName);
			if (!Double.TryParse(technicalSystem.uplink.frequency, NumberStyles.Any, CultureInfo.InvariantCulture, out double frequency))
			{
				throw new InvalidProfileParameterValueException(upLinkFrequencyProfileParameter.Name, technicalSystem.uplink.frequency);
			}

			upLinkFrequencyProfileParameter.Value = frequency;
		}

		private static void ConfigureSatelliteTxModulatingFunctionPolarization(Function function, synopsisTechnicalSystem technicalSystem)
		{
			ProfileParameter polarizationProfileParameter = function.Parameters.FirstOrDefault(x => x.Name == SrmConfiguration.PolarizationProfileParameterName);
			if (polarizationProfileParameter == null) throw new ProfileParameterNotFoundException(SrmConfiguration.PolarizationProfileParameterName);
			string polarity = polarizationProfileParameter.Discreets.Select(x => x.InternalValue).FirstOrDefault(x => x.StartsWith(technicalSystem.uplink.polarity, StringComparison.InvariantCultureIgnoreCase));
			if (polarity == null)
			{
				throw new InvalidProfileParameterValueException(polarizationProfileParameter.Name, technicalSystem.uplink.polarity);
			}

			polarizationProfileParameter.Value = polarity;
		}

		private static void ConfigureSatelliteTxModulatingFunctionFec(Function function, StreamName streamName)
		{
			ProfileParameter fecProfileParameter = function.Parameters.FirstOrDefault(x => x.Name == SrmConfiguration.FecProfileParameterName);
			if (fecProfileParameter == null) throw new ProfileParameterNotFoundException(SrmConfiguration.FecProfileParameterName);
			if (!fecProfileParameter.Discreets.Any(x => x.InternalValue.Equals(streamName.FEC)))
			{
				throw new InvalidProfileParameterValueException(fecProfileParameter.Name, streamName.FEC);
			}

			fecProfileParameter.Value = streamName.FEC;
		}

		private static void ConfigureSatelliteTxModulatingFunctionSymbolRate(Function function, StreamName streamName)
		{
			ProfileParameter symbolRateProfileParameter = function.Parameters.FirstOrDefault(x => x.Name == SrmConfiguration.SymbolRateProfileParameterName);
			if (symbolRateProfileParameter == null) throw new ProfileParameterNotFoundException(SrmConfiguration.SymbolRateProfileParameterName);
			if (streamName.SymbolRate < symbolRateProfileParameter.RangeMin || streamName.SymbolRate > symbolRateProfileParameter.RangeMax)
			{
				throw new InvalidProfileParameterValueException(symbolRateProfileParameter.Name, streamName.SymbolRate);
			}

			symbolRateProfileParameter.Value = Math.Round(streamName.SymbolRate, symbolRateProfileParameter.Decimals);
		}

		private static void ConfigureSatelliteTxModulatingFunctionModulationStandard(Function function, StreamName streamName)
		{
			ProfileParameter modulationStandardProfileParameter = function.Parameters.FirstOrDefault(x => x.Name == SrmConfiguration.ModulationStandardProfileParameterName);
			if (modulationStandardProfileParameter == null) throw new ProfileParameterNotFoundException(SrmConfiguration.ModulationStandardProfileParameterName);
			string modulationStandard = modulationStandardProfileParameter.Discreets.Select(x => x.InternalValue).FirstOrDefault(x => x.Equals(streamName.ModulationStandard, StringComparison.InvariantCultureIgnoreCase));
			if (modulationStandard == null)
			{
				throw new InvalidProfileParameterValueException(modulationStandardProfileParameter.Name, streamName.ModulationStandard);
			}

			modulationStandardProfileParameter.Value = modulationStandard;
		}

		private static void ConfigureSatelliteTxModulatingFunctionModulation(Function function, StreamName streamName)
		{
			ProfileParameter modulationProfileParameter = function.Parameters.FirstOrDefault(x => x.Name == SrmConfiguration.ModulationProfileParameterName);
			if (modulationProfileParameter == null) throw new ProfileParameterNotFoundException(SrmConfiguration.ModulationProfileParameterName);
			string modulation = modulationProfileParameter.Discreets.Select(x => x.InternalValue).FirstOrDefault(x => x.Equals(streamName.Modulation, StringComparison.InvariantCultureIgnoreCase));
			if (modulation == null)
			{
				throw new InvalidProfileParameterValueException(modulationProfileParameter.Name, streamName.Modulation);
			}

			modulationProfileParameter.Value = modulation;
		}

		private static void ConfigureSatelliteTxModulatingFunctionEncryption(Function function, synopsisOrigin origin, synopsisTechnicalSystem technicalSystem)
		{
			ProfileParameter encryptionKeyProfileParameter = function.Parameters.FirstOrDefault(x => x.Name == SrmConfiguration.EncryptionKeyProfileParameterName);
			if (encryptionKeyProfileParameter == null) throw new ProfileParameterNotFoundException(SrmConfiguration.EncryptionKeyProfileParameterName);

			ProfileParameter encryptionTypeProfileParameter = function.Parameters.FirstOrDefault(x => x.Name == SrmConfiguration.EncryptionTypeProfileParameterName);
			if (encryptionTypeProfileParameter == null) throw new ProfileParameterNotFoundException(SrmConfiguration.EncryptionTypeProfileParameterName);
			string encryptionType = encryptionTypeProfileParameter.Discreets.Select(x => x.InternalValue).FirstOrDefault(x => x.Equals(technicalSystem.encryptionTypeCode, StringComparison.InvariantCultureIgnoreCase));
			if (encryptionType == null)
			{
				// No encryption required
				encryptionTypeProfileParameter.Value = SrmConfiguration.EncryptionTypeFreeProfileParameterValue;
				encryptionKeyProfileParameter.Value = String.Empty;
			}
			else
			{
				// Use encryption key from the technical system or the origin
				encryptionTypeProfileParameter.Value = encryptionType;
				if (!String.IsNullOrWhiteSpace(technicalSystem.encryptionKey))
				{
					encryptionKeyProfileParameter.Value = technicalSystem.encryptionKey;
				}
				else if (!String.IsNullOrWhiteSpace(origin.encryptionKey))
				{
					encryptionKeyProfileParameter.Value = origin.encryptionKey;
				}
				else
				{
					// No encryption key to assign
				}
			}
		}

		private FunctionResource GetSatelliteTxResource(string systemName)
		{
			var transmissionSatelliteResourcePool = helpers.ResourceManager.GetResourcePools(new Skyline.DataMiner.Net.Messages.ResourcePool { Name = SrmConfiguration.TransmissionSatelliteResourcePool }).FirstOrDefault();
			if (transmissionSatelliteResourcePool == null) throw new ResourcePoolNotFoundException(SrmConfiguration.TransmissionSatelliteResourcePool);

			var resource = helpers.ResourceManager.GetResources(FunctionResourceExposers.PoolGUIDs.Contains(transmissionSatelliteResourcePool.GUID)).FirstOrDefault(x => x.Name.StartsWith(systemName, StringComparison.InvariantCultureIgnoreCase));
			if (resource == null) throw new ResourceNotFoundException(systemName);

			return resource as FunctionResource;
		}

		private Service GenerateFullCapacityFiberTxService(synopsis synopsis, synopsisTechnicalSystem technicalSystem)
		{
			// Init Service
			Service service = GenerateDefaultIntegrationService(FiberTxFullCapacityServiceDefinition, synopsis.StartDateTime, synopsis.EndDateTime);
			service.EurovisionTransmissionNumber = synopsis.transmissionNo;
			service.EurovisionTechnicalSystemId = technicalSystem.technicalSystemId;

			// Configure Fiber Destination Function
			Function destinationFunction = service.Functions.FirstOrDefault();

			// Configure Fiber Destination Function - Video Format
			ProfileParameter videoFormatProfileParameter = destinationFunction.Parameters.FirstOrDefault(x => x.Name == SrmConfiguration.VideoFormatProfileParameterName);
			ConfigureVideoFormatProfileParameter(videoFormatProfileParameter, technicalSystem);

			// Configure Audio Channels
			ConfigureAudioChannels(service.AudioChannelConfiguration, technicalSystem);

			return service;
		}

		private Service GenerateEbuDestinationService(synopsis synopsis, synopsisTechnicalSystem technicalSystem, synopsisRouting routing)
		{
			string locationName;
			FunctionResource resource;

			if (!TryGetEbuDestinationLocationAndResource(routing, out locationName, out resource))
			{
				return null;
			}

			// Init Service
			Service service = GenerateDefaultIntegrationService(EbuDestinationServiceDefinition, synopsis.StartDateTime, synopsis.EndDateTime);
			service.EurovisionTransmissionNumber = synopsis.transmissionNo;
			service.EurovisionTechnicalSystemId = technicalSystem.technicalSystemId;

			// Configure EBU Destination Function
			Function destinationFunction = service.Functions.FirstOrDefault();

			// Configure EBU Destination Location
			ProfileParameter ebuDestinationLocationProfileParameter = destinationFunction.Parameters.FirstOrDefault(x => x.Name == SrmConfiguration.EbuDestinationLocationProfileParameterName);
			if (ebuDestinationLocationProfileParameter == null) throw new ProfileParameterNotFoundException(SrmConfiguration.EbuDestinationLocationProfileParameterName);
			ebuDestinationLocationProfileParameter.Value = locationName;

			// Configure Fiber Destination Function - Video Format
			ProfileParameter videoFormatProfileParameter = destinationFunction.Parameters.FirstOrDefault(x => x.Name == SrmConfiguration.VideoFormatProfileParameterName);
			ConfigureVideoFormatProfileParameter(videoFormatProfileParameter, technicalSystem);

			// Configure Audio Channels
			ConfigureAudioChannels(service.AudioChannelConfiguration, technicalSystem);

			// Assign Resource
			destinationFunction.Resource = resource;
			destinationFunction.EnforceSelectedResource = true;

			return service;
		}

		private bool TryGetEbuDestinationLocationAndResource(synopsisRouting routing, out string location, out FunctionResource resource)
		{
			location = null;
			resource = null;

			List<Tuple<Regex, string, string>> routingMapping = new List<Tuple<Regex, string, string>>
			{
				{ new Tuple<Regex, string, string>(new Regex("YLE TO ACE 01"), SrmConfiguration.FixedLineEbuSourceLocationAcesEbuProfileParameterValue, "SDI Aces to YLE 01.Destination") },
				{ new Tuple<Regex, string, string>(new Regex("YLE TO ACE 02"), SrmConfiguration.FixedLineEbuSourceLocationAcesEbuProfileParameterValue, "SDI Aces to YLE 02.Destination") },
				{ new Tuple<Regex, string, string>(new Regex("JI01HLKI"), SrmConfiguration.FixedLineEbuSourceLocationNordicRingProfileParameterValue, "JI 01.Destination") },
				{ new Tuple<Regex, string, string>(new Regex("JI02HLKI"), SrmConfiguration.FixedLineEbuSourceLocationNordicRingProfileParameterValue, "JI 02.Destination") },
				{ new Tuple<Regex, string, string>(new Regex("FI03HLKI"), SrmConfiguration.FixedLineEbuSourceLocationNordicRingProfileParameterValue, "FI 03.Destination") },
				{ new Tuple<Regex, string, string>(new Regex("FI01HLKI"), SrmConfiguration.FixedLineEbuSourceLocationNordicRingProfileParameterValue, "FI 01.Destination") },
			};

			string resourceName = null;
			foreach (var tuple in routingMapping)
			{
				if (tuple.Item1.IsMatch(routing.circuit))
				{
					location = tuple.Item2;
					resourceName = tuple.Item3;
					break;
				}
			}

			if (location == null || resourceName == null) return false;

			resource = GetResource("Destination.EBU Destination", resourceName);
			return true;
		}

		private static void ConfigureVideoFormatProfileParameter(ProfileParameter videoFormatProfileParameter, synopsisTechnicalSystem technicalSystem)
		{
			if (videoFormatProfileParameter == null) throw new ArgumentNullException("videoFormatProfileParameter");

			string[] splitRatioName = technicalSystem.ratioName.Split(' ');
			string resolution = null;
			string framerate = null;
			foreach (string ratio in splitRatioName)
			{
				if (ratio.EndsWith("i")) resolution = ratio;
				if (ratio.EndsWith("Hz")) framerate = ratio.Replace("Hz", String.Empty);
			}

			string videoFormat;
			if (resolution == null || framerate == null)
			{
				//throw new InvalidProfileParameterValueException(String.Format("ConfigureDecodingFunction|Could not parse a valid VideoFormat from {0}", technicalSystem.ratioName));
				// Use Default Video Format
				videoFormat = videoFormatProfileParameter.DefaultValue.StringValue;
			}
			else
			{
				// Find discreet value that matches parsed info
				string parsedVideoFormat = resolution.Trim() + framerate.Trim();
				videoFormat = videoFormatProfileParameter.Discreets.Select(x => x.InternalValue).FirstOrDefault(x => x.Equals(parsedVideoFormat, StringComparison.InvariantCultureIgnoreCase));
				if (videoFormat == null)
				{
					throw new InvalidProfileParameterValueException(String.Format("ConfigureDecodingFunction|{0} is not a valid Video Format value", parsedVideoFormat));
				}
			}

			videoFormatProfileParameter.Value = videoFormat;
		}

		private static void ConfigureAudioChannels(AudioChannelConfiguration audioChannelConfiguration, synopsisTechnicalSystem technicalSystem)
		{
			int pair;
			int channel;
			bool dolbyDecodingRequired = false;
			for (int i = 0; i < technicalSystem.audios.Length; i++)
			{
				channel = i % 2;
				pair = i + 1 - channel;

				AudioChannelPair audioChannelPair = audioChannelConfiguration.AudioChannelPairs.FirstOrDefault(x => x.Channel == pair);
				ProfileParameter audioChannelProfileParameter = (channel == 0) ? audioChannelPair.FirstChannelProfileParameter : audioChannelPair.SecondChannelProfileParameter;
				ProfileParameter audioChannelDescriptionProfileParameter = (channel == 0) ? audioChannelPair.FirstChannelDescriptionProfileParameter : audioChannelPair.SecondChannelDescriptionProfileParameter;

				switch (technicalSystem.audios[i].code)
				{
					case "-":
						audioChannelProfileParameter.Value = "None";
						audioChannelDescriptionProfileParameter.Value = String.Empty;
						break;
					case "I":
					case "IL":
					case "IR":
						audioChannelProfileParameter.Value = "International";
						audioChannelDescriptionProfileParameter.Value = String.Empty;
						break;
					case "DE":
						audioChannelProfileParameter.Value = "Dolby-E 5.1 International Mix";
						audioChannelDescriptionProfileParameter.Value = String.Empty;
						dolbyDecodingRequired = false;
						break;
					default:
						// All other and unsupported audio codes should be mapped to "Other"
						audioChannelProfileParameter.Value = "Other";
						audioChannelDescriptionProfileParameter.Value = technicalSystem.audios[i].text;
						break;
				}
			}

			// Audio Dolby Decoding Required
			if (audioChannelConfiguration.AudioDolbyDecodingRequiredProfileParameter != null)
			{
				audioChannelConfiguration.AudioDolbyDecodingRequiredProfileParameter.Value = SrmConfiguration.BooleanToProfileParameterValue(dolbyDecodingRequired);
			}
		}

		#endregion

		#region Generate Order

		public Order GenerateEbuOrder(synopsis synopsis)
		{
			// Generate Services
			List<Service> receptions = new List<Service>();
			Contract receptionContract = null; // Receptions can be handled by any of the supported customers (YLE, NEP, Nelonen, MTV)
			List<Service> transmissions = new List<Service>();
			Contract transmissionContract = CompanyDetails.Contracts.FirstOrDefault(x => x.Type == ContractType.BaseContract); // Transmissions will always be handled by YLE
			FixedEbuSatRxResourceHandler fixedResourceHandler = new FixedEbuSatRxResourceHandler(helpers);
 
			foreach (Tuple<Service, Contract> reception in GenerateReceptions(synopsis))
			{
				fixedResourceHandler.AssignFixedResource(reception.Item1);

				receptions.Add(reception.Item1);
				if (receptionContract != null && receptionContract.Company != reception.Item2.Company)
				{
					throw new EurovisionSynopsisException(synopsis.transmissionNo, "A single synopsis cannot define receptions for multiple companies.");
				}
				else
				{
					receptionContract = reception.Item2;
				}
			}

			transmissions.AddRange(GenerateTransmissions(synopsis));

			if (!receptions.Any() && !transmissions.Any())
			{
				return null;
			}

			// Generate new Eurovision Order
			return GenerateOrder(synopsis, receptions, receptionContract, transmissions, transmissionContract);
		}

		private Order GenerateOrder(synopsis synopsis, List<Service> receptions, Contract receptionContract, List<Service> transmissions, Contract transmissionContract)
		{
			// Determine Contract
			Contract contract = DetermineContract(receptions, receptionContract, transmissions, transmissionContract);

			// Determine Services
			Service source = DetermineOrderSourceService(receptions, synopsis.StartDateTime, synopsis.EndDateTime);
			Service transmission = DetermineOrderTransmissionService(transmissions);
			if (transmission != null) source.Children.Add(transmission);

			// Determine Order Name
			string orderName = DetermineOrderName(synopsis);

			// Determine security view ids
			HashSet<int> securityViewIds = GetSecurityViewIds(contract);

			// Build Order
			Order order = new Order
			{
				ManualName = orderName,
				Start = synopsis.StartDateTime,
				End = synopsis.EndDateTime,
				Status = OrderStatus.Preliminary,
				Comments = IntegrationText,
				Sources = new List<Service> { source },
				IntegrationType = IntegrationType,
				Type = OrderType.Video,
				Definition = new ServiceDefinition { BookingManagerElementName = SrmConfiguration.OrderBookingManagerElementName },
				Company = contract.Company,
				Contract = contract.Name,
				CreatedByUserName = "Eurovision",
				LastUpdatedBy = "Eurovision",
				Event = new Event(helpers)
				{
					Name = orderName,
					Company = contract.Company,
					Contract = contract.Name,
					IntegrationType = IntegrationType,
					Start = synopsis.StartDateTime,
					End = synopsis.EndDateTime,
					Status = Skyline.DataMiner.DeveloperCommunityLibrary.YLE.Event.Status.Confirmed,
					Info = IntegrationText,
					SecurityViewIds = securityViewIds
				},
				BillingInfo = new BillingInfo
				{
					BillableCompany = contract.Company,
					CustomerCompany = String.Empty,
				}
			};

			return order;
		}

		private HashSet<int> GetSecurityViewIds(Contract contract)
		{
			HashSet<int> viewIds = new HashSet<int>();

			// All EBU orders should be visible to MCR users
			viewIds.Add(CompanyDetails.McrSecurityViewId);

			// All EBU orders should be visible to the Company for which the Order was created (YLE, MTC, Kepit,...)
			viewIds.Add(contract.CompanySecurityViewId);

			// If the company has linked orders, the EBU orders should be visible to them as well
			foreach (Company linkedCompany in contract.LinkedCompanies)
			{
				viewIds.Add(linkedCompany.SecurityViewId);
			}

			return viewIds;
		}

		private Note GenerateEbuNote(synopsis synopsis)
		{
			var note = new Note
			{
				Title = DetermineOrderName(synopsis),
				Description = "Automatically generated note for Eurovision synopsis: " + synopsis.transmissionNo,
				StartDate = synopsis.StartDateTime,
				DueDate = synopsis.StartDateTime,
				EurovisionId = synopsis.transmissionNo,
				Status = Skyline.DataMiner.DeveloperCommunityLibrary.YLE.Notes.Status.Open,
				Page = Page.MCR
			};

			return note;
		}

		private static Contract DetermineContract(List<Service> receptions, Contract receptionContract, List<Service> transmissions, Contract transmissionContract)
		{
			if (receptions.Any() && !transmissions.Any())
			{
				return receptionContract;
			}
			else if (!receptions.Any() && transmissions.Any())
			{
				return transmissionContract;
			}
			else
			{
				if (receptionContract.Company == transmissionContract.Company)
				{
					return receptionContract;
				}
				else
				{
					throw new EurovisionSynopsisException("The synopsis defines receptions and transmissions for different companies.");
				}
			}
		}

		private Service DetermineOrderSourceService(List<Service> receptions, DateTime start, DateTime end)
		{
			Service source;
			if (!receptions.Any())
			{
				// No reception - generate Dummy Source
				source = Service.GenerateDummyReception(helpers, start, end);
			}
			else if (receptions.Count == 1)
			{
				// Just one reception - use service
				source = receptions[0];
			}
			else
			{
				// More than one reception - take the first one and save all services in the EurovisionServiceConfiguration property on the service
				source = receptions[0];
				List<ServiceConfiguration> configurations = new List<ServiceConfiguration>();
				foreach (Service reception in receptions)
				{
					configurations.Add(reception.GetConfiguration());
				}

				source.EurovisionServiceConfigurations = configurations;
			}

			return source;
		}

		private static Service DetermineOrderTransmissionService(List<Service> transmissions)
		{
			Service transmission;
			if (!transmissions.Any())
			{
				// No transmissions - do nothing
				transmission = null;
			}
			else if (transmissions.Count == 1)
			{
				// Just one transmission - use service
				transmission = transmissions[0];
			}
			else
			{
				// More than one transmission - take the first one and save all services in the EurovisionServiceConfiguration property on the service
				transmission = transmissions[0];
				List<ServiceConfiguration> configurations = new List<ServiceConfiguration>();
				foreach (Service service in transmissions)
				{
					configurations.Add(service.GetConfiguration());
				}

				transmission.EurovisionServiceConfigurations = configurations;
			}

			return transmission;
		}

		private static string DetermineOrderName(synopsis synopsis)
		{
			string orderName;
			if (!String.IsNullOrWhiteSpace(synopsis.nature1) || !String.IsNullOrWhiteSpace(synopsis.nature2))
			{
				string name = String.Format("{0} {1}", synopsis.nature1, synopsis.nature2).Trim();
				orderName = String.Format("{0} [{1}]", name, synopsis.transmissionNo).Clean();
			}
			else
			{
				orderName = String.Format("Eurovision [{0}]", synopsis.transmissionNo).Clean();
			}

			return orderName;
		}

		/// <summary>
		/// This method will update the existing Order with the values from the newly generated one.
		/// </summary>
		/// <param name="newOrder">Order that was generated in this script. Not saved yet in SRM.</param>
		/// <param name="existingOrder">Order that should be updated with the one generated in this script. This order has been saved or booked in the past.</param>
		private void UpdateOrder(Order newOrder, Order existingOrder, synopsis synopsis)
		{
			// Get Generated Services
			Service newReceptionService = newOrder.Sources.FirstOrDefault(x => x.BackupType == BackupType.None); // Never Null (Dummy or Reception)
			Service newTransmissionService = newReceptionService.Children.FirstOrDefault(); // Can be Null (Dummy, Tx or Destination)

			// Find and update services in existing Order with the given transmissionNumber
			// IsEurovisionService = manual EBU RX or EBU TX from LiveOrderForm.
			// IntegrationType == Eurovision = service generated through Integration logic.
			List<Service> existingServices = existingOrder.AllServices.Where(x => x.IsEurovisionService || x.IntegrationType == IntegrationType.Eurovision).ToList();
			helpers.Log(nameof(EurovisionIntegration), nameof(UpdateOrder), "Found the following EBU services in the existing order: " + String.Join(", ", existingServices.Select(x => x.Id)));

			foreach (Service existingService in existingServices)
			{
				switch (existingService.Definition.VirtualPlatform)
				{
					case VirtualPlatform.ReceptionEurovision:
						// Eurovision Reception that was configured from the CustomerUI
						// Replace with new service
						ReplaceService(existingOrder, newReceptionService, existingService);
						break;
					case VirtualPlatform.TransmissionEurovision:
						// Eurovision Transmission that was configured from the CustomerUI
						// Replace with new service
						ReplaceService(existingOrder, newTransmissionService, existingService);
						break;
					case VirtualPlatform.ReceptionNone:
						// Dummy EBU Reception or EBU Transmission - Contains multiple EBU Services in its EurovisionServiceConfigurations property
						// Update if multiple Receptions/Transmissions or replace if only one Reception/Transmission in update
						if (existingService.IsEbuDummyReception)
						{
							// Reception Dummy
							ReplaceService(existingOrder, newReceptionService, existingService);
						}
						else
						{
							// Transmission Dummy
							ReplaceService(existingOrder, newTransmissionService, existingService);
						}

						break;
					default:
						// Transmission, Destination, Reception that was generated by EBU Integration
						// Update if VP matches with new service else replace
						if (existingService.Definition.VirtualPlatformServiceType == VirtualPlatformType.Reception)
						{
							// Booked or saved EBU Reception
							UpdateService(existingOrder, newReceptionService, existingService);
						}
						else
						{
							// Booked or saved EBU Transmission
							UpdateService(existingOrder, newTransmissionService, existingService);
						}

						break;
				}
			}

			// Update last updated by property
			existingOrder.LastUpdatedBy = "Eurovision";

			// Optionally align service timing
			AlignServiceTimings(existingOrder, synopsis);

			// Extend original Order so all services are included
			DateTime minStartTime = existingOrder.AllServices.Select(x => x.Start).Min();
			DateTime maxEndTime = existingOrder.AllServices.Select(x => x.End).Max();
			existingOrder.Start = minStartTime;
			existingOrder.End = maxEndTime;
		}

		private void ReplaceService(Order existingOrder, Service newService, Service serviceToReplace)
		{
			if (existingOrder == null) throw new ArgumentNullException("existingOrder");
			if (newService == null) throw new ArgumentNullException("newService");
			if (serviceToReplace == null) throw new ArgumentNullException("serviceToReplace");

			helpers.Log(nameof(EurovisionIntegration), nameof(ReplaceService), $"Replacing service {serviceToReplace.Id} with {newService.Id}");
			Service parentService = existingOrder.AllServices.FirstOrDefault(x => x.Children.Any(y => y.Equals(serviceToReplace)));

			newService.NameOfServiceToTransmitOrRecord = serviceToReplace.NameOfServiceToTransmitOrRecord;

			if (parentService == null)
			{
				// Source Service
				existingOrder.Sources.Remove(serviceToReplace);

				newService.SetChildren(serviceToReplace.Children);
				existingOrder.Sources.Add(newService);
			}
			else
			{
				// Transmission Service
				parentService.Children.Remove(serviceToReplace);

				newService.SetChildren(serviceToReplace.Children);
				parentService.Children.Add(newService);
			}
		}

		private void UpdateService(Order existingOrder, Service newService, Service existingService)
		{
			Service actualNewService = newService;
			if (newService.Definition.Id != existingService.Definition.Id)
			{
				if (newService.EurovisionServiceConfigurations.Any())
				{
					// Check if Dummy contains a Service that matches the existingService - else replace it
					var possibleNewService = newService.EurovisionServiceConfigurations.Select(x => new DisplayedService(helpers, existingService.NodeId, existingService.NodeLabel, x)).FirstOrDefault(x => x.Definition.Id == existingService.Definition.Id);
					if (possibleNewService == null)
					{
						// Replace existing Service
						ReplaceService(existingOrder, newService, existingService);
						return;
					}
					else
					{
						actualNewService = possibleNewService;
						actualNewService.EurovisionServiceConfigurations = possibleNewService.EurovisionServiceConfigurations;
					}
				}
				else
				{
					// Replace existing Service
					ReplaceService(existingOrder, newService, existingService);
					return;
				}
			}

			UpdateService(existingService, actualNewService, IgnoredItems.ServiceSelection);
		}

		private static void AlignServiceTimings(Order order, synopsis synopsis)
		{
			// Check if service timings should be updated
			if (order.IntegrationType != IntegrationType.None && order.IntegrationType != IntegrationType.Eurovision) return;

			DateTime start = synopsis.StartDateTime;
			DateTime end = synopsis.EndDateTime;
			foreach (var service in order.AllServices)
			{
				if (service.IntegrationType != IntegrationType.None && service.IntegrationType != IntegrationType.Eurovision) continue;

				service.Start = start;
				service.End = end;
			}
		}

		/// <summary>
		/// Determines whether the Order should be booked or saved.
		/// </summary>
		/// <param name="order">Order to be evaluated.</param>
		/// <returns>Action to take when updating the Order in SRM.</returns>
		private static bool CanOrderBeBooked(Order order)
		{
			// Check for Destination, Recording or Transmission
			bool hasDestination = order.AllServices.Any(x => x.Definition != null && x.Definition.VirtualPlatform == VirtualPlatform.Destination);
			bool hasRecording = order.AllServices.Any(x => x.Definition != null && x.Definition.VirtualPlatform == VirtualPlatform.Recording);
			bool hasTransmission = order.AllServices.Any(x => x.Definition != null && x.Definition.VirtualPlatformServiceType == VirtualPlatformType.Transmission);

			// Check if order has any Dummy Services
			bool hasDummy = order.AllServices.Any(x => x.IsDummy);

			return (hasDestination || hasRecording || hasTransmission) && !hasDummy;
		}

		/// <summary>
		/// This will update the status of the updated Order and send notifications if necessary.
		/// </summary>
		/// <param name="order">Order for which its status should be reevaluated.</param>
		private void UpdateOrderStatus(Order order)
		{
			helpers.Log(nameof(EurovisionIntegration), nameof(UpdateOrderStatus), $"Original Status: {order.Status}");

			if (!order.IsSaved) return;

			// Order was saved - update status if the order was waiting on EBU
			order.Status = CanOrderBeBooked(order) ? OrderStatus.Planned : OrderStatus.Preliminary;

			helpers.Log(nameof(EurovisionIntegration), nameof(UpdateOrderStatus), $"Updated Status: {order.Status}");
		}

		#endregion

		private void AddOrUpdateEurovisionOrder(string transmissionNumber, Order order, synopsis synopsis)
		{
			// Check if any orders already exist and should be updated
			bool areUpdatesSuccessFul = true;
			var existingOrders = helpers.OrderManager.GetEurovisionOrders(transmissionNumber);
			existingOrders.AddRange(GetManuallyBookedOrders(transmissionNumber));

			Guid? orderId = null;
			Guid? eventId = null;

			if (existingOrders.Any())
			{
				bool orderEndIsInThePast = order.End <= DateTime.Now;
				if (orderEndIsInThePast)
				{
					orderManagerElement.SendResponse(new IntegrationResponse(IntegrationType.Eurovision, order.EurovisionTransmissionNumber)
					{
						Status = IntegrationUpdateStatus.OK,
						AdditionalInformation = $"AddOrUpdateEurovisionOrder|No Update Required|EBU order end {order.End} is in the past (now: {DateTime.Now})",
					});

					return;
				}

				// retrieve the locks + accept changes first before updating any order
				foreach (var existingOrder in existingOrders)
				{
					RetrieveLock(existingOrder);
					existingOrder.AcceptChanges(helpers);
				}

				foreach (var existingOrder in existingOrders)
				{
					if (existingOrder == null) continue;

					helpers.AddOrderReferencesForLogging(order.Id);
					
					helpers.Log(nameof(EurovisionIntegration), nameof(AddOrUpdateEurovisionOrder), $"Updating Order: {existingOrder.Name}");

					// Update existing Eurovision Orders
					UpdateOrder(order, existingOrder, synopsis);
					UpdateOrderStatus(existingOrder);
					areUpdatesSuccessFul &= AddOrUpdateOrder(existingOrder);

					orderId = existingOrder.Id;
					eventId = existingOrder.Event.Id;
				}
			}
			else
			{
				bool orderStartIsMoreThan5MinutesInTheFuture = DateTime.Now.AddMinutes(5) <= order.Start; // 5 minutes is an arbitrary value to make sure the service booking can be completed before the start of the order
				if (!orderStartIsMoreThan5MinutesInTheFuture)
				{
					orderManagerElement.SendResponse(new IntegrationResponse(IntegrationType.Eurovision, order.EurovisionTransmissionNumber)
					{
						Status = IntegrationUpdateStatus.OK,
						AdditionalInformation = $"AddOrUpdateEurovisionOrder|No Update Required|EBU order start {order.Start} is in the past or too close to now ({DateTime.Now})"
					});

					return;
				}

				// Save newly generated Eurovision Order
				areUpdatesSuccessFul = AddOrUpdateOrder(order);

				orderId = order.Id;
				eventId = order.Event.Id;
			}

			if (areUpdatesSuccessFul)
			{
				orderManagerElement.SendResponse(new IntegrationResponse(IntegrationType.Eurovision, order.EurovisionTransmissionNumber)
				{
					Status = IntegrationUpdateStatus.OK,
					AdditionalInformation = "AddOrUpdateEurovisionOrder|Action succeeded|Adding or updating order succeeded",
					OrderId = orderId,
					EventId = eventId
				});
			}
			else
			{
				orderManagerElement.SendResponse(new IntegrationResponse(IntegrationType.Eurovision, order.EurovisionTransmissionNumber)
				{
					Status = IntegrationUpdateStatus.Failed,
					AdditionalInformation = "AddOrUpdateEurovisionOrder|Action failed|Adding or updating order failed"
				});
			}
		}

		/// <summary>
		/// Checks all EBU elements on the DMA for work orders that have the given transmission number.
		/// </summary>
		/// <param name="transmissionNumber"></param>
		/// <returns></returns>
		private List<Order> GetManuallyBookedOrders(string transmissionNumber)
		{
			var elements = helpers.Engine.FindElementsByProtocol(EurovisionProtocolName, EurovisionProtocolVersion);
			var dms = Engine.SLNetRaw.GetDms();

			HashSet<string> workOrderIds = new HashSet<string>();
			foreach (var element in elements)
			{
				var dmsElement = dms.GetElement(new Skyline.DataMiner.Core.DataMinerSystem.Common.DmsElementId(element.DmaId, element.ElementId));
				var workOrdersTable = dmsElement.GetTable(WorkOrdersTablePid);

				// Retrieve work orders that have the synopsis transmission number as "transmission number"
				// This is the case for receptions (Type = PARTICIPATION)
				var receptionWorkOrders = workOrdersTable.QueryData(new []
				{
					new Skyline.DataMiner.Core.DataMinerSystem.Common.ColumnFilter { Pid = WorkOrdersTableTransmissionNumberPid, Value = transmissionNumber, ComparisonOperator = Skyline.DataMiner.Core.DataMinerSystem.Common.ComparisonOperator.Equal }
				});

				string type;
				foreach (object[] receptionWorkOrder in receptionWorkOrders)
				{
					type = Convert.ToString(receptionWorkOrder[WorkOrdersTableWorkOrderTypeIdx]);
					if (type.IndexOf("TRANSMISSION", StringComparison.InvariantCultureIgnoreCase) < 0) workOrderIds.Add(Convert.ToString(receptionWorkOrder[WorkOrdersTableWorkOrderIdIdx]));
				}

				// Retrieve work orders that have the synopsis transmission number as "number"
				// This is the case for transmissions (Type = TRANMSISSION or NONTRANSMISSION)
				var transmissionWorkOrders = workOrdersTable.QueryData(new []
				{
					new Skyline.DataMiner.Core.DataMinerSystem.Common.ColumnFilter { Pid = WorkOrdersTableNumberPid, Value = transmissionNumber, ComparisonOperator = Skyline.DataMiner.Core.DataMinerSystem.Common.ComparisonOperator.Equal }
				});

				foreach (object[] transmissionWorkOrder in transmissionWorkOrders)
				{
					type = Convert.ToString(transmissionWorkOrder[WorkOrdersTableWorkOrderTypeIdx]);
					if (type.IndexOf("TRANSMISSION", StringComparison.InvariantCultureIgnoreCase) >= 0) workOrderIds.Add(Convert.ToString(transmissionWorkOrder[WorkOrdersTableWorkOrderIdIdx]));
				}
			}

			helpers.Log(nameof(EurovisionIntegration), nameof(GetManuallyBookedOrders), $"Found linked Work Order IDs {String.Join(", ", workOrderIds)} for Transmission Number: {transmissionNumber}");
			
			List<Order> existingManualOrders = new List<Order>();
			foreach (string workOrderId in workOrderIds)
			{
				existingManualOrders.AddRange(helpers.OrderManager.GetManualEurovisionOrders(workOrderId));
			}

			helpers.Log(nameof(EurovisionIntegration), nameof(GetManuallyBookedOrders), $"Manually requested EBU orders: {String.Join(", ", existingManualOrders.Select(x => x.Name))}");

			return existingManualOrders;
		}

		private void AddOrUpdateEurovisionNote(Note note)
		{
			// check if a note for this synopsis id already exists
			var existingNote = helpers.NoteManager.GetEurovisionNote(note.EurovisionId);
			if (existingNote != null)
			{
				existingNote.Title = note.Title;
				existingNote.StartDate = note.StartDate;
				existingNote.DueDate = note.DueDate;

				note = existingNote;
			}

			if (helpers.NoteManager.AddOrUpdateNote(note, out var fullTicketId))
			{
				orderManagerElement.SendResponse(new IntegrationResponse(IntegrationType.Eurovision, note.EurovisionId)
				{
					Status = IntegrationUpdateStatus.OK,
					AdditionalInformation = "AddOrUpdateEurovisionNote|Action succeeded|Adding or updating note succeeded"
				});
			}
			else
			{
				orderManagerElement.SendResponse(new IntegrationResponse(IntegrationType.Eurovision, note.EurovisionId)
				{
					Status = IntegrationUpdateStatus.Failed,
					AdditionalInformation = "AddOrUpdateEurovisionNote|Action failed|Adding or updating note failed"
				});
			}
		}

		private bool AddOrUpdateOrder(Order order)
		{
			try
			{
				var tasks = order.AddOrUpdate(helpers, false).Tasks;
				if (!tasks.Any(x => x.Status == TaskStatus.Fail)) return true;

				// Contains failed tasks
				helpers.Log(nameof(EurovisionIntegration), nameof(AddOrUpdateOrder), "Add or Update failed, rolling back...");
				var rollbackTasks = tasks.Where(t => t.Status == TaskStatus.Ok).Select(t => t.CreateRollbackTask()).Where(t => t != null).Reverse().ToList();
				foreach (var rollbackTask in rollbackTasks)
				{
					if (!rollbackTask.Execute())
					{
						break;
					}
				}

				return false;
			}
			catch (Exception e)
			{
				helpers.Log(nameof(EurovisionIntegration), nameof(AddOrUpdateOrder), $"Add or Update Failed: {e}");
				return false;
			}
		}

		// Remove caching of these service definitions as this caused the profile parameters of services that use the same definition to be the same object.
		private ServiceDefinition SatelliteRxServiceDefinition
		{
			get
			{
				return helpers.ServiceDefinitionManager.GetServiceDefinition(SrmConfiguration.SatelliteReceptionServiceDefinitionId);
			}
		}

		private ServiceDefinition FiberRxFullCapacityServiceDefinition
		{
			get
			{
				return helpers.ServiceDefinitionManager.GetServiceDefinition(SrmConfiguration.FiberFullCapacityReceptionServiceDefinitionId);
			}
		}

		private ServiceDefinition FixedLineEbuRxServiceDefinition
		{
			get
			{
				return helpers.ServiceDefinitionManager.GetServiceDefinition(SrmConfiguration.FixedLineEbuReceptionServiceDefinitionId);
			}
		}

		private ServiceDefinition SatelliteTxServiceDefinition
		{
			get
			{
				return helpers.ServiceDefinitionManager.GetServiceDefinition(SrmConfiguration.SatelliteTransmissionServiceDefinitionId);
			}
		}

		private ServiceDefinition FiberTxFullCapacityServiceDefinition
		{
			get
			{
				return helpers.ServiceDefinitionManager.GetServiceDefinition(SrmConfiguration.FiberFullCapacityTransmissionServiceDefinitionId);
			}
		}

		private ServiceDefinition EbuDestinationServiceDefinition
		{
			get
			{
				return helpers.ServiceDefinitionManager.GetServiceDefinition(SrmConfiguration.EbuDestinationServiceDefinitionId);
			}
		}
	}
}